<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Meal Planner App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input, textarea, select {
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        button {
            cursor: pointer;
        }
        .form-checkbox:checked {
            background-color: #3B82F6; /* Blue-600 */
            border-color: #3B82F6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Hide element utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 antialiased">
    <div id="app-root">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg rounded-b-xl">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold mb-2 sm:mb-0">Meal Planner for Nutritionists</h1>
                <div class="flex space-x-4">
                    <button id="recipes-btn" class="px-5 py-2 rounded-full text-lg font-medium transition-all duration-300 bg-white text-blue-700 shadow-md">
                        Recipes
                    </button>
                    <button id="meal-plans-btn" class="px-5 py-2 rounded-full text-lg font-medium transition-all duration-300 bg-blue-500 hover:bg-blue-400 text-white">
                        Meal Plans
                    </button>
                </div>
            </div>
        </header>

        <!-- User ID Display -->
        <div class="container mx-auto mt-4 p-3 bg-gray-100 rounded-lg shadow-sm text-sm text-gray-600">
            <p><strong>Your User ID:</strong> <span id="user-id-display">Loading...</span></p>
            <p class="text-xs text-gray-500 mt-1">This ID identifies your data. If sharing is enabled by security rules, others can use this ID to find your public data.</p>
        </div>

        <!-- Main Content Area -->
        <main id="main-content" class="container mx-auto p-4 py-8">
            <!-- Content will be rendered here by JavaScript -->
            <div id="loading-spinner" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div class="text-center text-gray-700 text-xl font-semibold animate-pulse">Loading application...</div>
            </div>
            <div id="error-display" class="hidden min-h-screen flex items-center justify-center bg-red-100 p-4">
                <div class="text-center text-red-700 text-lg font-medium" id="error-message"></div>
            </div>
        </main>
    </div>

    <!-- Reusable Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all duration-300 scale-100 opacity-100">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Action</h3>
            <p class="text-gray-700 mb-6" id="confirm-modal-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-800 font-medium hover:bg-gray-300 transition duration-200">
                    Cancel
                </button>
                <button id="confirm-modal-confirm" class="px-5 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition duration-200">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Reusable Recipe Detail Modal -->
    <div id="recipe-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all duration-300 scale-100 opacity-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="modal-recipe-name"></h3>
                <button id="modal-recipe-close" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            <div class="space-y-3 text-gray-700 text-base max-h-96 overflow-y-auto pr-2">
                <p><strong>Ingredients:</strong> <span id="modal-recipe-ingredients"></span></p>
                <p><strong>Instructions:</strong> <span id="modal-recipe-instructions"></span></p>
                <p><strong>Nutritional Info:</strong> <span id="modal-recipe-nutrition"></span></p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="modal-recipe-close-btn" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and app state
        let db;
        let auth;
        let currentUserId;
        let currentAppId;

        // Application state
        const appState = {
            currentPage: 'recipes', // 'recipes' or 'mealPlans'
            recipes: [],
            mealPlans: [],
            newRecipe: { name: '', ingredients: '', instructions: '', nutritionalInfo: '' },
            editRecipeId: null,
            newMealPlan: {
                name: '',
                description: '',
                dailyMeals: {
                    monday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    tuesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    wednesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    thursday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    friday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    saturday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    sunday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                }
            },
            editMealPlanId: null,
            message: '',
            messageType: '',
            searchTerm: {
                recipes: '',
                mealPlans: ''
            },
            confirmModal: {
                isOpen: false,
                message: '',
                onConfirm: null,
                onCancel: null
            },
            recipeDetailModal: {
                isOpen: false,
                recipe: null
            }
        };

        const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];

        // --- Helper Functions ---

        // Exponential backoff for fetch calls (though not used for Firestore directly)
        async function exponentialBackoffFetch(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    }
                    return response;
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Show message display
        function showMessage(text, type) {
            appState.message = text;
            appState.messageType = type;
            renderMessageDisplay();
            setTimeout(() => {
                appState.message = '';
                appState.messageType = '';
                renderMessageDisplay();
            }, 3000);
        }

        // Render Message Display
        function renderMessageDisplay() {
            const mainContent = document.getElementById('main-content');
            let messageDiv = mainContent.querySelector('#message-display');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'message-display';
                mainContent.prepend(messageDiv); // Prepend to ensure it's at the top
            }

            if (appState.message) {
                const bgColor = appState.messageType === 'success' ? 'bg-green-100' : 'bg-red-100';
                const textColor = appState.messageType === 'success' ? 'text-green-700' : 'text-red-700';
                messageDiv.className = `p-3 mb-4 rounded-lg text-sm ${bgColor} ${textColor} shadow-md`;
                messageDiv.textContent = appState.message;
            } else {
                messageDiv.className = 'hidden';
                messageDiv.textContent = '';
            }
        }

        // Show Confirmation Modal
        function showConfirmationModal(message, onConfirm, onCancel) {
            appState.confirmModal = { isOpen: true, message, onConfirm, onCancel };
            renderConfirmationModal();
        }

        // Hide Confirmation Modal
        function hideConfirmationModal() {
            appState.confirmModal = { isOpen: false, message: '', onConfirm: null, onCancel: null };
            renderConfirmationModal();
        }

        // Render Confirmation Modal
        function renderConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const messageEl = document.getElementById('confirm-modal-message');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');

            if (appState.confirmModal.isOpen) {
                modal.classList.remove('hidden');
                messageEl.textContent = appState.confirmModal.message;

                // Remove previous listeners to prevent duplicates
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;

                confirmBtn.onclick = () => {
                    if (appState.confirmModal.onConfirm) appState.confirmModal.onConfirm();
                    hideConfirmationModal();
                };
                cancelBtn.onclick = () => {
                    if (appState.confirmModal.onCancel) appState.confirmModal.onCancel();
                    hideConfirmationModal();
                };
            } else {
                modal.classList.add('hidden');
            }
        }

        // Show Recipe Detail Modal
        function showRecipeDetailModal(recipe) {
            appState.recipeDetailModal = { isOpen: true, recipe };
            renderRecipeDetailModal();
        }

        // Hide Recipe Detail Modal
        function hideRecipeDetailModal() {
            appState.recipeDetailModal = { isOpen: false, recipe: null };
            renderRecipeDetailModal();
        }

        // Render Recipe Detail Modal
        function renderRecipeDetailModal() {
            const modal = document.getElementById('recipe-detail-modal');
            const nameEl = document.getElementById('modal-recipe-name');
            const ingredientsEl = document.getElementById('modal-recipe-ingredients');
            const instructionsEl = document.getElementById('modal-recipe-instructions');
            const nutritionEl = document.getElementById('modal-recipe-nutrition');
            const closeBtn = document.getElementById('modal-recipe-close');
            const closeBtn2 = document.getElementById('modal-recipe-close-btn');

            if (appState.recipeDetailModal.isOpen && appState.recipeDetailModal.recipe) {
                modal.classList.remove('hidden');
                const recipe = appState.recipeDetailModal.recipe;
                nameEl.textContent = recipe.name;
                ingredientsEl.textContent = recipe.ingredients;
                instructionsEl.textContent = recipe.instructions || 'N/A';
                nutritionEl.textContent = recipe.nutritionalInfo || 'N/A';

                closeBtn.onclick = hideRecipeDetailModal;
                closeBtn2.onclick = hideRecipeDetailModal;
            } else {
                modal.classList.add('hidden');
            }
        }


        // --- Firebase Initialization ---

        async function initFirebase() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        currentUserId = crypto.randomUUID(); // Fallback for anonymous
                    }
                    document.getElementById('user-id-display').textContent = currentUserId;
                    document.getElementById('loading-spinner').classList.add('hidden');
                    renderApp(); // Render the app once authenticated
                    setupRealtimeListeners(); // Start listening to data
                });

            } catch (err) {
                console.error("Failed to initialize Firebase:", err);
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('error-display').classList.remove('hidden');
                document.getElementById('error-message').textContent = "Failed to initialize the application. Please try again. " + err.message;
            }
        }

        // --- Real-time Data Listeners ---

        function setupRealtimeListeners() {
            if (!db || !currentUserId) return;

            // Listen for recipes
            const recipesColRef = collection(db, `artifacts/${currentAppId}/public/data/recipes`);
            const qRecipes = query(recipesColRef, where("nutritionistId", "==", currentUserId));
            onSnapshot(qRecipes, (snapshot) => {
                appState.recipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (appState.currentPage === 'recipes') {
                    renderRecipeManager(); // Re-render if on recipes page
                } else if (appState.currentPage === 'mealPlans') {
                    renderMealPlanManager(); // Re-render meal plans to update recipe names
                }
            }, (error) => {
                console.error("Error fetching recipes:", error);
                showMessage("Failed to load recipes.", 'error');
            });

            // Listen for meal plans
            const mealPlansColRef = collection(db, `artifacts/${currentAppId}/public/data/mealPlans`);
            const qMealPlans = query(mealPlansColRef, where("nutritionistId", "==", currentUserId));
            onSnapshot(qMealPlans, (snapshot) => {
                appState.mealPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (appState.currentPage === 'mealPlans') {
                    renderMealPlanManager(); // Re-render if on meal plans page
                }
            }, (error) => {
                console.error("Error fetching meal plans:", error);
                showMessage("Failed to load meal plans.", 'error');
            });
        }

        // --- Main App Rendering ---

        function renderApp() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = ''; // Clear existing content

            renderMessageDisplay(); // Ensure message display is set up

            if (appState.currentPage === 'recipes') {
                renderRecipeManager();
                document.getElementById('recipes-btn').classList.add('bg-white', 'text-blue-700', 'shadow-md');
                document.getElementById('recipes-btn').classList.remove('bg-blue-500', 'hover:bg-blue-400', 'text-white');
                document.getElementById('meal-plans-btn').classList.remove('bg-white', 'text-blue-700', 'shadow-md');
                document.getElementById('meal-plans-btn').classList.add('bg-blue-500', 'hover:bg-blue-400', 'text-white');
            } else if (appState.currentPage === 'mealPlans') {
                renderMealPlanManager();
                document.getElementById('meal-plans-btn').classList.add('bg-white', 'text-blue-700', 'shadow-md');
                document.getElementById('meal-plans-btn').classList.remove('bg-blue-500', 'hover:bg-blue-400', 'text-white');
                document.getElementById('recipes-btn').classList.remove('bg-white', 'text-blue-700', 'shadow-md');
                document.getElementById('recipes-btn').classList.add('bg-blue-500', 'hover:bg-blue-400', 'text-white');
            }
        }

        // --- Recipe Manager Functions ---

        function renderRecipeManager() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Recipe Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6" id="recipe-form-title"></h2>
                        <form id="recipe-form" class="space-y-4">
                            <div>
                                <label for="recipe-name" class="block text-sm font-medium text-gray-700 mb-1">Recipe Name</label>
                                <input type="text" id="recipe-name" name="name" placeholder="e.g., Chicken Stir-fry" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" required>
                            </div>
                            <div>
                                <label for="recipe-ingredients" class="block text-sm font-medium text-gray-700 mb-1">Ingredients (comma-separated)</label>
                                <textarea id="recipe-ingredients" name="ingredients" rows="4" placeholder="e.g., 1 chicken breast, 1 cup broccoli, 1 tbsp soy sauce" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" required></textarea>
                            </div>
                            <div>
                                <label for="recipe-instructions" class="block text-sm font-medium text-gray-700 mb-1">Instructions</label>
                                <textarea id="recipe-instructions" name="instructions" rows="4" placeholder="e.g., 1. Cut chicken. 2. Stir-fry vegetables..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"></textarea>
                            </div>
                            <div>
                                <label for="recipe-nutritionalInfo" class="block text-sm font-medium text-gray-700 mb-1">Nutritional Info (optional)</label>
                                <input type="text" id="recipe-nutritionalInfo" name="nutritionalInfo" placeholder="e.g., 350 calories, 30g protein" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            </div>
                            <div class="flex space-x-3">
                                <button type="submit" id="recipe-submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105"></button>
                                <button type="button" id="recipe-cancel-edit-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 hidden">
                                    Cancel Edit
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Recipe List -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Your Recipes</h2>
                        <div class="mb-4">
                            <input type="text" id="recipe-search" placeholder="Search recipes..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        </div>
                        <ul id="recipes-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                            <!-- Recipes will be loaded here -->
                        </ul>
                    </div>
                </div>
            `;

            // Get form elements and set initial values/text
            const recipeFormTitle = document.getElementById('recipe-form-title');
            const recipeNameInput = document.getElementById('recipe-name');
            const recipeIngredientsInput = document.getElementById('recipe-ingredients');
            const recipeInstructionsInput = document.getElementById('recipe-instructions');
            const recipeNutritionalInfoInput = document.getElementById('recipe-nutritionalInfo');
            const recipeSubmitBtn = document.getElementById('recipe-submit-btn');
            const recipeCancelEditBtn = document.getElementById('recipe-cancel-edit-btn');
            const recipeSearchInput = document.getElementById('recipe-search');

            recipeSearchInput.value = appState.searchTerm.recipes;
            recipeSearchInput.oninput = (e) => {
                appState.searchTerm.recipes = e.target.value;
                updateRecipeList();
            };

            if (appState.editRecipeId) {
                recipeFormTitle.textContent = 'Edit Recipe';
                recipeSubmitBtn.textContent = 'Update Recipe';
                recipeCancelEditBtn.classList.remove('hidden');
                const recipeToEdit = appState.recipes.find(r => r.id === appState.editRecipeId);
                if (recipeToEdit) {
                    recipeNameInput.value = recipeToEdit.name;
                    recipeIngredientsInput.value = recipeToEdit.ingredients;
                    recipeInstructionsInput.value = recipeToEdit.instructions;
                    recipeNutritionalInfoInput.value = recipeToEdit.nutritionalInfo;
                }
            } else {
                recipeFormTitle.textContent = 'Add New Recipe';
                recipeSubmitBtn.textContent = 'Add Recipe';
                recipeCancelEditBtn.classList.add('hidden');
                recipeNameInput.value = appState.newRecipe.name;
                recipeIngredientsInput.value = appState.newRecipe.ingredients;
                recipeInstructionsInput.value = appState.newRecipe.instructions;
                recipeNutritionalInfoInput.value = appState.newRecipe.nutritionalInfo;
            }

            // Event listeners for form inputs
            recipeNameInput.oninput = (e) => appState.newRecipe.name = e.target.value;
            recipeIngredientsInput.oninput = (e) => appState.newRecipe.ingredients = e.target.value;
            recipeInstructionsInput.oninput = (e) => appState.newRecipe.instructions = e.target.value;
            recipeNutritionalInfoInput.oninput = (e) => appState.newRecipe.nutritionalInfo = e.target.value;

            // Form submission handler
            document.getElementById('recipe-form').onsubmit = (e) => {
                e.preventDefault();
                if (appState.editRecipeId) {
                    updateRecipe();
                } else {
                    addRecipe();
                }
            };

            // Cancel edit button handler
            recipeCancelEditBtn.onclick = () => {
                appState.editRecipeId = null;
                appState.newRecipe = { name: '', ingredients: '', instructions: '', nutritionalInfo: '' };
                renderRecipeManager();
            };

            updateRecipeList(); // Initial render of the recipe list
        }

        function updateRecipeList() {
            const recipesList = document.getElementById('recipes-list');
            recipesList.innerHTML = ''; // Clear existing list

            const filteredRecipes = appState.recipes.filter(recipe =>
                recipe.name.toLowerCase().includes(appState.searchTerm.recipes.toLowerCase()) ||
                recipe.ingredients.toLowerCase().includes(appState.searchTerm.recipes.toLowerCase())
            );

            if (filteredRecipes.length === 0) {
                recipesList.innerHTML = `<p class="text-gray-500">No recipes found. Try adjusting your search or add some!</p>`;
                return;
            }

            filteredRecipes.forEach(recipe => {
                const li = document.createElement('li');
                li.className = "bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200";
                li.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800">${recipe.name}</h3>
                    <p class="text-gray-600 mt-1 text-sm"><strong>Ingredients:</strong> ${recipe.ingredients}</p>
                    ${recipe.instructions ? `<p class="text-gray-600 mt-1 text-sm"><strong>Instructions:</strong> ${recipe.instructions}</p>` : ''}
                    ${recipe.nutritionalInfo ? `<p class="text-gray-600 mt-1 text-sm"><strong>Nutrition:</strong> ${recipe.nutritionalInfo}</p>` : ''}
                    <div class="mt-3 flex space-x-2">
                        <button data-id="${recipe.id}" class="edit-recipe-btn bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-4 py-2 rounded-md transition duration-200 shadow-sm">
                            Edit
                        </button>
                        <button data-id="${recipe.id}" class="delete-recipe-btn bg-red-500 hover:bg-red-600 text-white text-sm px-4 py-2 rounded-md transition duration-200 shadow-sm">
                            Delete
                        </button>
                    </div>
                `;
                recipesList.appendChild(li);
            });

            // Attach event listeners to newly created buttons
            recipesList.querySelectorAll('.edit-recipe-btn').forEach(button => {
                button.onclick = (e) => {
                    const recipeId = e.target.dataset.id;
                    const recipeToEdit = appState.recipes.find(r => r.id === recipeId);
                    if (recipeToEdit) {
                        appState.editRecipeId = recipeId;
                        appState.newRecipe = { ...recipeToEdit }; // Copy existing data
                        renderRecipeManager();
                    }
                };
            });

            recipesList.querySelectorAll('.delete-recipe-btn').forEach(button => {
                button.onclick = (e) => {
                    const recipeId = e.target.dataset.id;
                    showConfirmationModal("Are you sure you want to delete this recipe? This action cannot be undone.",
                        () => deleteRecipe(recipeId),
                        () => {} // Do nothing on cancel
                    );
                };
            });
        }

        async function addRecipe() {
            if (!appState.newRecipe.name.trim() || !appState.newRecipe.ingredients.trim()) {
                showMessage("Recipe name and ingredients cannot be empty.", 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${currentAppId}/public/data/recipes`), {
                    ...appState.newRecipe,
                    nutritionistId: currentUserId,
                    createdAt: new Date().toISOString()
                });
                appState.newRecipe = { name: '', ingredients: '', instructions: '', nutritionalInfo: '' };
                renderRecipeManager(); // Re-render form to clear inputs
                showMessage("Recipe added successfully!", 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to add recipe.", 'error');
            }
        }

        async function updateRecipe() {
            if (!appState.editRecipeId) return;
            if (!appState.newRecipe.name.trim() || !appState.newRecipe.ingredients.trim()) {
                showMessage("Recipe name and ingredients cannot be empty.", 'error');
                return;
            }

            try {
                const recipeRef = doc(db, `artifacts/${currentAppId}/public/data/recipes`, appState.editRecipeId);
                await updateDoc(recipeRef, {
                    name: appState.newRecipe.name,
                    ingredients: appState.newRecipe.ingredients,
                    instructions: appState.newRecipe.instructions,
                    nutritionalInfo: appState.newRecipe.nutritionalInfo,
                    updatedAt: new Date().toISOString()
                });
                appState.editRecipeId = null;
                appState.newRecipe = { name: '', ingredients: '', instructions: '', nutritionalInfo: '' };
                renderRecipeManager(); // Re-render form to clear inputs
                showMessage("Recipe updated successfully!", 'success');
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage("Failed to update recipe.", 'error');
            }
        }

        async function deleteRecipe(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${currentAppId}/public/data/recipes`, id));
                showMessage("Recipe deleted successfully!", 'success');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Failed to delete recipe.", 'error');
            }
        }

        // --- Meal Plan Manager Functions ---

        function renderMealPlanManager() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Meal Plan Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6" id="meal-plan-form-title"></h2>
                        <form id="meal-plan-form" class="space-y-4">
                            <div>
                                <label for="meal-plan-name" class="block text-sm font-medium text-gray-700 mb-1">Meal Plan Name</label>
                                <input type="text" id="meal-plan-name" name="name" placeholder="e.g., Week 1 Detox Plan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" required>
                            </div>
                            <div>
                                <label for="meal-plan-description" class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                                <textarea id="meal-plan-description" name="description" rows="3" placeholder="e.g., A plan focused on lean protein and fresh vegetables." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"></textarea>
                            </div>

                            <div class="space-y-6">
                                <label class="block text-lg font-semibold text-gray-800 mb-2">Assign Recipes to Days & Meals</label>
                                <div id="daily-meals-selection">
                                    <!-- Daily meal selection will be rendered here -->
                                </div>
                            </div>

                            <div class="flex space-x-3 mt-6">
                                <button type="submit" id="meal-plan-submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105"></button>
                                <button type="button" id="meal-plan-cancel-edit-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 hidden">
                                    Cancel Edit
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Meal Plan List -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Your Meal Plans</h2>
                        <div class="mb-4">
                            <input type="text" id="meal-plan-search" placeholder="Search meal plans..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        </div>
                        <ul id="meal-plans-list" class="space-y-6 max-h-[600px] overflow-y-auto pr-2">
                            <!-- Meal plans will be loaded here -->
                        </ul>
                    </div>
                </div>
            `;

            // Get form elements and set initial values/text
            const mealPlanFormTitle = document.getElementById('meal-plan-form-title');
            const mealPlanNameInput = document.getElementById('meal-plan-name');
            const mealPlanDescriptionInput = document.getElementById('meal-plan-description');
            const mealPlanSubmitBtn = document.getElementById('meal-plan-submit-btn');
            const mealPlanCancelEditBtn = document.getElementById('meal-plan-cancel-edit-btn');
            const mealPlanSearchInput = document.getElementById('meal-plan-search');
            const dailyMealsSelectionDiv = document.getElementById('daily-meals-selection');

            mealPlanSearchInput.value = appState.searchTerm.mealPlans;
            mealPlanSearchInput.oninput = (e) => {
                appState.searchTerm.mealPlans = e.target.value;
                updateMealPlanList();
            };

            if (appState.editMealPlanId) {
                mealPlanFormTitle.textContent = 'Edit Meal Plan';
                mealPlanSubmitBtn.textContent = 'Update Meal Plan';
                mealPlanCancelEditBtn.classList.remove('hidden');
                const planToEdit = appState.mealPlans.find(p => p.id === appState.editMealPlanId);
                if (planToEdit) {
                    mealPlanNameInput.value = planToEdit.name;
                    mealPlanDescriptionInput.value = planToEdit.description;
                    // Deep copy dailyMeals to avoid direct mutation
                    appState.newMealPlan.dailyMeals = JSON.parse(JSON.stringify(planToEdit.dailyMeals || {
                        monday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        tuesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        wednesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        thursday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        friday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        saturday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        sunday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    }));
                }
            } else {
                mealPlanFormTitle.textContent = 'Create New Meal Plan';
                mealPlanSubmitBtn.textContent = 'Create Meal Plan';
                mealPlanCancelEditBtn.classList.add('hidden');
                mealPlanNameInput.value = appState.newMealPlan.name;
                mealPlanDescriptionInput.value = appState.newMealPlan.description;
                // Reset dailyMeals for new plan
                appState.newMealPlan.dailyMeals = {
                    monday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    tuesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    wednesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    thursday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    friday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    saturday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    sunday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                };
            }

            // Event listeners for form inputs
            mealPlanNameInput.oninput = (e) => appState.newMealPlan.name = e.target.value;
            mealPlanDescriptionInput.oninput = (e) => appState.newMealPlan.description = e.target.value;

            // Render daily meal selection
            renderDailyMealSelection(dailyMealsSelectionDiv);

            // Form submission handler
            document.getElementById('meal-plan-form').onsubmit = (e) => {
                e.preventDefault();
                if (appState.editMealPlanId) {
                    updateMealPlan();
                } else {
                    addMealPlan();
                }
            };

            // Cancel edit button handler
            mealPlanCancelEditBtn.onclick = () => {
                appState.editMealPlanId = null;
                appState.newMealPlan = {
                    name: '',
                    description: '',
                    dailyMeals: {
                        monday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        tuesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        wednesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        thursday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        friday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        saturday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        sunday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    }
                };
                renderMealPlanManager();
            };

            updateMealPlanList(); // Initial render of the meal plan list
        }

        function renderDailyMealSelection(container) {
            container.innerHTML = ''; // Clear previous content

            if (appState.recipes.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">No recipes available. Please add recipes first in the "Recipes" tab.</p>`;
                return;
            }

            daysOfWeek.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = "bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm";
                dayDiv.innerHTML = `<h4 class="text-md font-bold text-gray-700 mb-3 capitalize">${day}</h4>`;
                const mealsGrid = document.createElement('div');
                mealsGrid.className = "grid grid-cols-2 sm:grid-cols-4 gap-4";

                mealTypes.forEach(mealType => {
                    const mealTypeDiv = document.createElement('div');
                    mealTypeDiv.innerHTML = `
                        <p class="text-sm font-medium text-gray-600 mb-1 capitalize">${mealType}</p>
                        <div class="space-y-1 max-h-24 overflow-y-auto border border-gray-300 rounded-md p-2 bg-white" id="recipes-for-${day}-${mealType}">
                            <!-- Checkboxes for recipes -->
                        </div>
                    `;
                    const recipeCheckboxesDiv = mealTypeDiv.querySelector(`#recipes-for-${day}-${mealType}`);

                    appState.recipes.forEach(recipe => {
                        const label = document.createElement('label');
                        label.className = "flex items-center space-x-2 text-sm cursor-pointer";
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'form-checkbox h-4 w-4 text-blue-600 rounded';
                        checkbox.value = recipe.id;
                        checkbox.checked = appState.newMealPlan.dailyMeals[day][mealType].includes(recipe.id);
                        checkbox.onchange = () => handleDailyMealSelection(day, mealType, recipe.id);

                        const span = document.createElement('span');
                        span.className = 'text-gray-800';
                        span.textContent = recipe.name;

                        label.appendChild(checkbox);
                        label.appendChild(span);
                        recipeCheckboxesDiv.appendChild(label);
                    });
                    mealsGrid.appendChild(mealTypeDiv);
                });
                dayDiv.appendChild(mealsGrid);
                container.appendChild(dayDiv);
            });
        }

        function handleDailyMealSelection(day, mealType, recipeId) {
            const currentRecipes = appState.newMealPlan.dailyMeals[day][mealType];
            const isSelected = currentRecipes.includes(recipeId);
            if (isSelected) {
                appState.newMealPlan.dailyMeals[day][mealType] = currentRecipes.filter(id => id !== recipeId);
            } else {
                appState.newMealPlan.dailyMeals[day][mealType] = [...currentRecipes, recipeId];
            }
            // Re-render only the relevant section or form to update checkboxes
            const dailyMealsSelectionDiv = document.getElementById('daily-meals-selection');
            if (dailyMealsSelectionDiv) {
                 renderDailyMealSelection(dailyMealsSelectionDiv);
            }
        }

        function isAnyRecipeSelectedForMealPlan(dailyMeals) {
            for (const day in dailyMeals) {
                for (const mealType in dailyMeals[day]) {
                    if (dailyMeals[day][mealType].length > 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        async function addMealPlan() {
            if (!appState.newMealPlan.name.trim()) {
                showMessage("Meal plan name cannot be empty.", 'error');
                return;
            }
            if (!isAnyRecipeSelectedForMealPlan(appState.newMealPlan.dailyMeals)) {
                showMessage("Meal plan must include at least one recipe.", 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${currentAppId}/public/data/mealPlans`), {
                    name: appState.newMealPlan.name,
                    description: appState.newMealPlan.description,
                    dailyMeals: appState.newMealPlan.dailyMeals,
                    nutritionistId: currentUserId,
                    createdAt: new Date().toISOString()
                });
                appState.newMealPlan = {
                    name: '',
                    description: '',
                    dailyMeals: {
                        monday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        tuesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        wednesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        thursday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        friday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        saturday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        sunday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    }
                };
                renderMealPlanManager(); // Re-render form to clear inputs
                showMessage("Meal plan added successfully!", 'success');
            } catch (e) {
                console.error("Error adding meal plan: ", e);
                showMessage("Failed to add meal plan.", 'error');
            }
        }

        async function updateMealPlan() {
            if (!appState.editMealPlanId) return;
            if (!appState.newMealPlan.name.trim()) {
                showMessage("Meal plan name cannot be empty.", 'error');
                return;
            }
            if (!isAnyRecipeSelectedForMealPlan(appState.newMealPlan.dailyMeals)) {
                showMessage("Meal plan must include at least one recipe.", 'error');
                return;
            }

            try {
                const mealPlanRef = doc(db, `artifacts/${currentAppId}/public/data/mealPlans`, appState.editMealPlanId);
                await updateDoc(mealPlanRef, {
                    name: appState.newMealPlan.name,
                    description: appState.newMealPlan.description,
                    dailyMeals: appState.newMealPlan.dailyMeals,
                    updatedAt: new Date().toISOString()
                });
                appState.editMealPlanId = null;
                appState.newMealPlan = {
                    name: '',
                    description: '',
                    dailyMeals: {
                        monday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        tuesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        wednesday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        thursday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        friday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        saturday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                        sunday: { breakfast: [], lunch: [], dinner: [], snack: [] },
                    }
                };
                renderMealPlanManager(); // Re-render form to clear inputs
                showMessage("Meal plan updated successfully!", 'success');
            } catch (e) {
                console.error("Error updating meal plan: ", e);
                showMessage("Failed to update meal plan.", 'error');
            }
        }

        async function deleteMealPlan(id) {
            try {
                await deleteDoc(doc(db, `artifacts/${currentAppId}/public/data/mealPlans`, id));
                showMessage("Meal plan deleted successfully!", 'success');
            } catch (e) {
                console.error("Error deleting meal plan: ", e);
                showMessage("Failed to delete meal plan.", 'error');
            }
        }

        function updateMealPlanList() {
            const mealPlansList = document.getElementById('meal-plans-list');
            mealPlansList.innerHTML = ''; // Clear existing list

            const filteredMealPlans = appState.mealPlans.filter(plan =>
                plan.name.toLowerCase().includes(appState.searchTerm.mealPlans.toLowerCase()) ||
                plan.description.toLowerCase().includes(appState.searchTerm.mealPlans.toLowerCase())
            );

            if (filteredMealPlans.length === 0) {
                mealPlansList.innerHTML = `<p class="text-gray-500">No meal plans found. Try adjusting your search or create one!</p>`;
                return;
            }

            filteredMealPlans.forEach(plan => {
                const li = document.createElement('li');
                li.className = "bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200";
                li.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800">${plan.name}</h3>
                    ${plan.description ? `<p class="text-gray-600 mt-1 text-sm"><strong>Description:</strong> ${plan.description}</p>` : ''}

                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                        ${daysOfWeek.map(day => `
                            <div class="bg-white p-3 rounded-md border border-gray-200">
                                <h4 class="font-bold text-gray-700 mb-2 capitalize">${day}</h4>
                                ${mealTypes.map(mealType => `
                                    <div class="mb-1">
                                        <p class="font-medium text-gray-600 capitalize">${mealType}:</p>
                                        <ul class="list-disc list-inside ml-2 text-gray-800">
                                            ${(plan.dailyMeals && plan.dailyMeals[day] && plan.dailyMeals[day][mealType] && plan.dailyMeals[day][mealType].length > 0) ?
                                                plan.dailyMeals[day][mealType].map(recipeId => {
                                                    const recipe = appState.recipes.find(r => r.id === recipeId);
                                                    return `<li class="hover:text-blue-600 cursor-pointer transition-colors duration-200 view-recipe-details" data-recipe-id="${recipeId}">
                                                                ${recipe ? recipe.name : 'Unknown Recipe'}
                                                            </li>`;
                                                }).join('')
                                                : `<li class="text-gray-500 italic">No recipes</li>`
                                            }
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-4 flex space-x-2">
                        <button data-id="${plan.id}" class="edit-meal-plan-btn bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-4 py-2 rounded-md transition duration-200 shadow-sm">
                            Edit
                        </button>
                        <button data-id="${plan.id}" class="delete-meal-plan-btn bg-red-500 hover:bg-red-600 text-white text-sm px-4 py-2 rounded-md transition duration-200 shadow-sm">
                            Delete
                        </button>
                    </div>
                `;
                mealPlansList.appendChild(li);
            });

            // Attach event listeners to newly created buttons
            mealPlansList.querySelectorAll('.edit-meal-plan-btn').forEach(button => {
                button.onclick = (e) => {
                    const planId = e.target.dataset.id;
                    const planToEdit = appState.mealPlans.find(p => p.id === planId);
                    if (planToEdit) {
                        appState.editMealPlanId = planId;
                        appState.newMealPlan = {
                            name: planToEdit.name,
                            description: planToEdit.description,
                            dailyMeals: JSON.parse(JSON.stringify(planToEdit.dailyMeals || {})) // Deep copy
                        };
                        renderMealPlanManager();
                    }
                };
            });

            mealPlansList.querySelectorAll('.delete-meal-plan-btn').forEach(button => {
                button.onclick = (e) => {
                    const planId = e.target.dataset.id;
                    showConfirmationModal("Are you sure you want to delete this meal plan? This action cannot be undone.",
                        () => deleteMealPlan(planId),
                        () => {} // Do nothing on cancel
                    );
                };
            });

            mealPlansList.querySelectorAll('.view-recipe-details').forEach(element => {
                element.onclick = (e) => {
                    const recipeId = e.target.dataset.recipeId;
                    const recipe = appState.recipes.find(r => r.id === recipeId);
                    if (recipe) {
                        showRecipeDetailModal(recipe);
                    } else {
                        showMessage("Recipe details not found.", 'error');
                    }
                };
            });
        }


        // --- Global Event Listeners ---
        window.onload = function() {
            initFirebase();

            document.getElementById('recipes-btn').onclick = () => {
                appState.currentPage = 'recipes';
                renderApp();
            };

            document.getElementById('meal-plans-btn').onclick = () => {
                appState.currentPage = 'mealPlans';
                renderApp();
            };
        };
    </script>
</body>
</html>
